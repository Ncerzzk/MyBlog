# 最近滤波心得
ctime:2018-03-13 17:10:21 +0800|1520932221

标签（空格分隔）： 技术

---

这几天在写四轴的定高。

使用的方法是：将加速度计得到的三轴加速度通过四元数旋转至天地坐标系，以此得到一个相对于地面的Z轴加速度。（当然，如果能保证四轴一直悬停——俯仰角、横滚角都是0，也可以不必旋转，直接采用Z轴加速度即可）

将这个Z轴加速度积分两次，得到一个高度。用气压计的高度来与这个高度进行互补滤波。（因为气压计毛刺多，低通滤波效果试了不好）

发现如果仅用一阶互补滤波，即气压计高度与积分高度做差，补偿在Z轴速度上，毛刺还是很多。且由于积分的漂移，加速度积分到速度这一环节中，速度就会朝一个方向漂移了，长期下去，如果补偿系数太小，误差会越来越大。如果补偿系数太大，那么就相当于只用气压计高度了。

后来想到一个办法，即气压计高度与积分高度做差之后，不仅补偿在速度上，而且补偿在加速度上。因为这个积分误差的根源就在于加速度计的误差。很朴素的一个思想，想着前人肯定有人想到了，得有数学证明这个办法是可行的，搜了一下，原来这叫“二阶互补滤波”。

用这个思路改进之后，得到的高度果然没有了毛刺，十分平滑！

另一个，是发现当四轴电机转起来之后，姿态解算的角度会有4°以上的误差。体现在悬停的时候四轴会往一边偏。暑假调“小绿鲤鱼”的时候就出现过这种情况，我当时以为是平衡没调好。光辉反馈是“一起飞就往一边偏，调都调不回来”。

我以为是电机转起来给磁力计带来影响，但又发现yaw环并没有影响，还是挺准的。后来看了加速度计的波形才发现原来是电机旋转起来之后，加速度噪声引起的姿态解算的偏差。

知道原因之后就好办了，首先是初始化MPU6050的时候，提高DLPF，即内置的低通滤波器，后来发现没啥效果，且延时增大，弃用。

接下来是减少角速度环的D值，因为我怀疑这些噪声是由于高频振动引起的，而D值就是引起高频振动的一个元凶。后来发现同样没啥效果。

最后是在网上搜了一些文章，提到了“窗口滑动滤波”。于是在AHR解算的函数中，增加了一个对加速度的8窗口滑动滤波，效果拔群！




