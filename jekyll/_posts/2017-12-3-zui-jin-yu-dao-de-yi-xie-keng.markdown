---
layout: post
title: 最近遇到的一些坑
date: 2017-12-03 01:05:28 +0900
categories: 技术 硬件
issue_id: 23
---

最近在外面接了一个私活，其实也不是最近，在我特保答辩完之后，张总介绍的。是很久之前他接下来的，不过一直没催，他也就一直拖着。张总明年就毕业了，没时间做，于是把项目转给我了。

说实话，一开始不是很想接的，但是张总在特保答辩的时候帮我了不少忙，不好意思拒绝，就接了下来。

项目是做一个DEMO环境，简单说就是一个传感器黑盒，盒子中有很多传感器，还有电机。任务就是采电机运行期间各个传感器的值，然后用网口传出来。

乍一看很容易，做的期间遇到了不少坑。

- 网口问题：用F407跑LWIP，一开始死活跑不通，不管是跑TCP_Server，还是跑TCP_Client，以为是买的模块的问题，在网上赶紧买了两个顺丰过来。最后发现是有个网络名放置的时候错位的，最后那个引脚和相邻的引脚短路起来，并把错误引脚设置为输入模式解决了。
- TCP_Write发着发着就死了的问题。弄了半天，没解决，似乎是发的数量太多，又太频繁，导致内存分配出了问题。最后发送内容部分用UDP实现。
- MPU6050、及BME280等I2C器件无法写入的问题。很奇怪，I2C居然出现可以正常读取，但是不能写入的问题。后来发现是I2C_WriteByte写的有问题。原来的写法是：
    1. 发送从机地址、写命令，发送寄存器地址
    2. 发送从机地址、写命令，发送要写入的值
	
后来发现正确的写法是：

    1. 发送从机地址、写命令，发送寄存器地址及要写入的值（也就是把寄存器地址和要写入的值放在一个数组中，直接一起发过去）
	
很显然，第二种写法更符合逻辑一点。第一种写法多发了一个起始条件和从机地址，可能就使上次发过去的寄存器地址失效了，所以导致一直没有写入。

但是，最奇怪的是，第一种写法在我F405的四旋翼上居然跑的十分正常，一点问题也没有，于是直接复制到407上面出现问题的时候，我一直没往这里怀疑，又以为是MPU6050坏了，在网上又买了两个。

- 编码器模式无法读取值的问题。使用编码器接口，要读入一个PWM脉冲，发现死活读不了。后来发现是，编码器接口必须是AB相都接，也就是一个脉冲相当于只有一相，无法计数，即使有计数也只是0 1之间跳变。后来用PWM输入模式解决了。






