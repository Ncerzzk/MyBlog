<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>SpinalHDL学习 | Huangzzk’s Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="SpinalHDL学习" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="SpinalHDL是Scala的一个用于描述硬件的方言，与chisel类似，但听说设计会比chisel完备一点， 因此准备花一些时间来学习一下。" />
<meta property="og:description" content="SpinalHDL是Scala的一个用于描述硬件的方言，与chisel类似，但听说设计会比chisel完备一点， 因此准备花一些时间来学习一下。" />
<link rel="canonical" href="https://ncerzzk.github.io/%E6%8A%80%E6%9C%AF/hdl/2020/06/13/SpinalHDL-xue-xi.html" />
<meta property="og:url" content="https://ncerzzk.github.io/%E6%8A%80%E6%9C%AF/hdl/2020/06/13/SpinalHDL-xue-xi.html" />
<meta property="og:site_name" content="Huangzzk’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-13T21:08:06+08:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ncerzzk.github.io/%E6%8A%80%E6%9C%AF/hdl/2020/06/13/SpinalHDL-xue-xi.html"},"url":"https://ncerzzk.github.io/%E6%8A%80%E6%9C%AF/hdl/2020/06/13/SpinalHDL-xue-xi.html","headline":"SpinalHDL学习","dateModified":"2020-06-13T21:08:06+08:00","datePublished":"2020-06-13T21:08:06+08:00","description":"SpinalHDL是Scala的一个用于描述硬件的方言，与chisel类似，但听说设计会比chisel完备一点， 因此准备花一些时间来学习一下。","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://ncerzzk.github.io/feed.xml" title="Huangzzk's Blog" /><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9a0d201458675d03a87e467407e4889b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Huangzzk&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/aboutme/">关于</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <style type="text/css">
.css_btn_class {
	font-size:16px;
	font-family:Arial;
	font-weight:normal;
	-moz-border-radius:8px;
	-webkit-border-radius:8px;
	border-radius:8px;
	border:1px solid #dcdcdc;
	padding:9px 18px;
	text-decoration:none;
	background:-webkit-gradient( linear, left top, left bottom, color-stop(5%, #ffffff), color-stop(100%, #f6f6f6) );
	background:-moz-linear-gradient( center top, #ffffff 5%, #f6f6f6 100% );
	background:-ms-linear-gradient( top, #ffffff 5%, #f6f6f6 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#f6f6f6');
	background-color:#ffffff;
	color:#666666;
	display:inline-block;
	text-shadow:1px 1px 0px #ffffff;
 	-webkit-box-shadow:inset 1px 1px 0px 0px #ffffff;
 	-moz-box-shadow:inset 1px 1px 0px 0px #ffffff;
 	box-shadow:inset 1px 1px 0px 0px #ffffff;
}.css_btn_class:hover {
	background:-webkit-gradient( linear, left top, left bottom, color-stop(5%, #f6f6f6), color-stop(100%, #ffffff) );
	background:-moz-linear-gradient( center top, #f6f6f6 5%, #ffffff 100% );
	background:-ms-linear-gradient( top, #f6f6f6 5%, #ffffff 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#f6f6f6', endColorstr='#ffffff');
	background-color:#f6f6f6;
}.css_btn_class:active {
	position:relative;
	top:1px;
}

.comment_username{
font-size:14px;
margin-left:5px;
}
.comment_time{
font-size:14px;	
	float:right;
	margin-right:5px;
}
.comment{
	list-style:none;
}
.comment_username{
	color: #24292e;
	text-decoration: none;
	}
	.comment_user_img{
	float:left;
}
.comment_box{
	margin-left:40px;
    color: #24292e;
    background-color: #fff;
    border: 1px solid #d1d5da;
    border-radius: 3px;
}
.comment_content{
margin:10px 10px 10px 10px;
}

#comment{
	margin-top:30px;
}

.comment{
	margin-top:30px;
}

/* CSS按钮生成器 */
</style>

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">SpinalHDL学习</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-06-13T21:08:06+08:00" itemprop="datePublished">Jun 13, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>SpinalHDL是Scala的一个用于描述硬件的方言，与chisel类似，但听说设计会比chisel完备一点，
因此准备花一些时间来学习一下。</p>

<p>专门学习了一下scala的语法，走马观花看了一圈，挺复杂的，从很多语言中学习了很多特性。有关函数式编程的一些概念，之前接触得也不多，不太懂，其他面向对象的东西与ruby有很多地方十分相似。</p>

<p>开始学习SpainaHDL的时候，发现了挺多语法在原生的Scala中是没有的，因为Scala的自由性，所以自定义一些控制结构是完全可能的，偏偏我这个人好奇心又重，总想搞明白某些DSL的语法是怎么用Scala实现的，因此下面对于一些重要的SpinaHDL语法，除了搞明白用途以外，也会想想是怎么实现的。因为时间有限，大部分权作为猜测，等以后有时间好好学一下Scala的时候，再验证是不是吧。</p>

<h2 id="spainahdl-执行流程大致分析">SpainaHDL 执行流程大致分析</h2>

<ul>
  <li>
    <p>在main中，调用SpinalVerilog,（传入顶层类的一个对象）（实际上传入的是一个方法gen，这个方法实例化顶层对象）</p>

    <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">object</span> <span class="nc">SpinalVerilog</span> <span class="o">{</span>
<span class="k">def</span> <span class="nf">apply</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;:</span> <span class="kt">Component</span><span class="o">](</span><span class="n">config</span><span class="k">:</span> <span class="kt">SpinalConfig</span><span class="o">)(</span><span class="n">gen</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">SpinalReport</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Spinal</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">copy</span><span class="o">(</span><span class="n">mode</span> <span class="k">=</span> <span class="nc">Verilog</span><span class="o">))(</span><span class="n">gen</span><span class="o">)</span>
<span class="k">def</span> <span class="nf">apply</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;:</span> <span class="kt">Component</span><span class="o">](</span><span class="n">gen</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">SpinalReport</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="nc">SpinalConfig</span><span class="o">(</span><span class="n">mode</span> <span class="k">=</span> <span class="nc">Verilog</span><span class="o">).</span><span class="py">generate</span><span class="o">(</span><span class="n">gen</span><span class="o">)</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>接下来会调用SpinalConfig的generate方法，并将gen传入,这是一个case Class,实例化不需要使用new，并指定mode为Verilog。
    <ul>
      <li>
        <p>这里的Verilog是单例对象，在文件开头有定义</p>

        <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">VHDL</span>    <span class="k">extends</span> <span class="nc">SpinalMode</span>
<span class="k">object</span> <span class="nc">Verilog</span> <span class="k">extends</span> <span class="nc">SpinalMode</span>
<span class="k">object</span> <span class="nc">SystemVerilog</span> <span class="k">extends</span> <span class="nc">SpinalMode</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>generate方法：</p>

    <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">generate</span>       <span class="o">[</span><span class="kt">T</span> <span class="k">&lt;:</span> <span class="kt">Component</span><span class="o">](</span><span class="n">gen</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">SpinalReport</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Spinal</span><span class="o">(</span><span class="k">this</span><span class="o">)(</span><span class="n">gen</span><span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Spinal是一个单例对象(object),在applay方法中，判断语言类型（是VHDL还是verilog）</p>

    <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">val</span> <span class="nv">report</span> <span class="k">=</span> <span class="nv">configPatched</span><span class="o">.</span><span class="py">mode</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">`VHDL`</span>    <span class="k">=&gt;</span> <span class="nc">SpinalVhdlBoot</span><span class="o">(</span><span class="n">configPatched</span><span class="o">)(</span><span class="n">gen</span><span class="o">)</span>
    <span class="k">case</span> <span class="n">`Verilog`</span> <span class="k">=&gt;</span> <span class="nc">SpinalVerilogBoot</span><span class="o">(</span><span class="n">configPatched</span><span class="o">)(</span><span class="n">gen</span><span class="o">)</span>
    <span class="k">case</span> <span class="n">`SystemVerilog`</span> <span class="k">=&gt;</span> <span class="nc">SpinalVerilogBoot</span><span class="o">(</span><span class="n">configPatched</span><span class="o">)(</span><span class="n">gen</span><span class="o">)</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>SpinalVerilogBoot 继续是一个单例对象</p>

    <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="nf">singleShot</span><span class="o">(</span><span class="n">config</span><span class="o">)(</span><span class="n">gen</span><span class="o">)</span>
</code></pre></div>    </div>
    <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">singleShot</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;:</span> <span class="kt">Component</span><span class="o">](</span><span class="n">config</span><span class="k">:</span> <span class="kt">SpinalConfig</span><span class="o">)(</span><span class="n">gen</span> <span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">SpinalReport</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">={</span>

  <span class="k">val</span> <span class="nv">pc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PhaseContext</span><span class="o">(</span><span class="n">config</span><span class="o">)</span> <span class="c1">// 这里创建了上下文，上下文主要是为了模块嵌套的时候，防止名称冲突</span>
  <span class="nv">pc</span><span class="o">.</span><span class="py">globalData</span><span class="o">.</span><span class="py">phaseContext</span> <span class="k">=</span> <span class="n">pc</span>
  <span class="nv">pc</span><span class="o">.</span><span class="py">globalData</span><span class="o">.</span><span class="py">anonymSignalPrefix</span> <span class="k">=</span> <span class="nf">if</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">anonymSignalPrefix</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="s">"_zz"</span> <span class="k">else</span> <span class="nv">config</span><span class="o">.</span><span class="py">anonymSignalPrefix</span>

  <span class="o">...</span>

  <span class="nc">SpinalProgress</span><span class="o">(</span><span class="s">"Elaborate components"</span><span class="o">)</span>

  <span class="k">val</span> <span class="nv">phases</span> <span class="k">=</span> <span class="nc">ArrayBuffer</span><span class="o">[</span><span class="kt">Phase</span><span class="o">]()</span>

  <span class="c1">// 以下开始创建一堆任务</span>
  <span class="n">phases</span> <span class="o">+=</span> <span class="k">new</span> <span class="nc">PhaseCreateComponent</span><span class="o">(</span><span class="n">gen</span><span class="o">)(</span><span class="n">pc</span><span class="o">)</span>
  <span class="n">phases</span> <span class="o">+=</span> <span class="k">new</span> <span class="nc">PhaseDummy</span><span class="o">(</span><span class="nc">SpinalProgress</span><span class="o">(</span><span class="s">"Checks and transforms"</span><span class="o">))</span>
  <span class="o">...</span>
  <span class="o">...</span>
  <span class="nf">for</span><span class="o">(</span><span class="n">phase</span> <span class="k">&lt;-</span> <span class="n">phases</span><span class="o">){</span>
    <span class="nf">if</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">verbose</span><span class="o">)</span> <span class="nc">SpinalProgress</span><span class="o">(</span><span class="n">s</span><span class="s">"${phase.getClass.getSimpleName}"</span><span class="o">)</span>
    <span class="nv">pc</span><span class="o">.</span><span class="py">doPhase</span><span class="o">(</span><span class="n">phase</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="一些基本的spinahdl例子">一些基本的SpinaHDL例子</h2>

<h3 id="生成hdl">生成HDL</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyAdder</span><span class="o">(</span><span class="n">width</span><span class="k">:</span> <span class="kt">BitCount</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Component</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Bundle</span><span class="o">{</span>
    <span class="k">val</span> <span class="nv">a</span><span class="o">,</span><span class="n">b</span>    <span class="k">=</span> <span class="n">in</span> <span class="nc">UInt</span><span class="o">(</span><span class="n">width</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">result</span> <span class="k">=</span> <span class="n">out</span> <span class="nc">UInt</span><span class="o">(</span><span class="n">width</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="nv">io</span><span class="o">.</span><span class="py">result</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">a</span> <span class="o">+</span> <span class="nv">io</span><span class="o">.</span><span class="py">b</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Main</span><span class="o">{</span>
  <span class="k">def</span> <span class="nf">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
    <span class="nc">SpinalVhdl</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyAdder</span><span class="o">(</span><span class="mi">32</span> <span class="n">bits</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="模块定义输入输出">模块定义，输入输出</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyComponent</span> <span class="k">extends</span> <span class="nc">Component</span> <span class="o">{</span>
 <span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
 <span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="n">in</span> <span class="nc">Bool</span>
 <span class="k">val</span> <span class="nv">b</span> <span class="k">=</span> <span class="n">in</span> <span class="nc">Bool</span>
 <span class="k">val</span> <span class="nv">c</span> <span class="k">=</span> <span class="n">in</span> <span class="nc">Bool</span>
 <span class="k">val</span> <span class="nv">result</span> <span class="k">=</span> <span class="n">out</span> <span class="nc">Bool</span>
 <span class="o">}</span>
 <span class="nv">io</span><span class="o">.</span><span class="py">result</span> <span class="o">:=</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">a</span> <span class="o">&amp;</span> <span class="nv">io</span><span class="o">.</span><span class="py">b</span><span class="o">)</span> <span class="o">|</span> <span class="o">(!</span><span class="nv">io</span><span class="o">.</span><span class="py">c</span><span class="o">)</span>
<span class="o">}</span>


</code></pre></div></div>
<ul>
  <li>in和out是单例对象，继承了IODirection的特质
    <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">IODirection</span> <span class="k">extends</span> <span class="nc">BaseTypeFactory</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">Bool</span><span class="o">()</span> <span class="k">=</span> <span class="nf">applyIt</span><span class="o">(</span><span class="nv">super</span><span class="o">.</span><span class="py">Bool</span><span class="o">())</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>bool是IODirection的方法，因此<code class="highlighter-rouge">in bool</code>相当于定于了一个bool类型的对象，且这个对象方向是<code class="highlighter-rouge">in</code>（这个方向在综合或者什么地方会用到）</li>
</ul>

<h3 id="组合逻辑-选择器">组合逻辑 选择器</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyComponent</span> <span class="k">extends</span> <span class="nc">Component</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
        <span class="k">val</span> <span class="nv">conds</span> <span class="k">=</span> <span class="nf">inVec</span><span class="o">(</span><span class="nc">Bool</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="k">val</span> <span class="nv">result</span> <span class="k">=</span> <span class="n">out</span> <span class="nc">UInt</span><span class="o">(</span><span class="mi">4</span> <span class="n">bits</span><span class="o">)</span>

    <span class="o">}</span>
    <span class="nf">when</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">conds</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
        <span class="nv">io</span><span class="o">.</span><span class="py">result</span><span class="k">:</span> <span class="o">=</span><span class="mi">2</span> <span class="nf">when</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">conds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
            <span class="nv">io</span><span class="o">.</span><span class="py">result</span><span class="k">:</span> <span class="o">=</span><span class="mi">1</span>

        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">otherwise</span> <span class="o">{</span>
        <span class="nv">io</span><span class="o">.</span><span class="py">result</span><span class="k">:</span> <span class="o">=</span><span class="mi">0</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>这里有个很有趣的语法<code class="highlighter-rouge">4 bits</code>
    <ul>
      <li>bits是IntBuilder类的一个方法，作用是生成Bitcount对象
        <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">IntBuilder</span><span class="o">(</span><span class="k">val</span> <span class="nv">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">bits</span>   <span class="k">=</span> <span class="k">new</span> <span class="nc">BitCount</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
    <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>上面的<code class="highlighter-rouge">4 bits</code>实际上省略了点号，可以写成<code class="highlighter-rouge">4.bits</code>，但是有一个问题，因为4是Int类的，为何可以调用IntBuilder类的方法呢？答案在于scala的隐式转换中。
    <ul>
      <li>在同文件中，定义了
        <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">implicit</span> <span class="k">def</span> <span class="nf">IntToBuilder</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IntBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IntBuilder</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</code></pre></div>        </div>
      </li>
      <li>有了这个隐式转换，scala会自动将Int类转为IntBuilder类（如果有需要的话）</li>
    </ul>
  </li>
  <li>通过上面说的这些方式，实现了<code class="highlighter-rouge">4 bits</code>这个程序员看起来有点奇怪，但是可读性非常强的语法。scala真是强阿。</li>
  <li>when语法，实际上when是一个单例对象，是通过scala的语法自定义的控制结构。
    <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">when</span> <span class="o">{</span>

<span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">cond</span><span class="k">:</span> <span class="kt">Bool</span><span class="o">)(</span><span class="n">block</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">WhenContext</span> <span class="o">=</span> <span class="o">{</span>

  <span class="k">val</span> <span class="nv">whenStatement</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WhenStatement</span><span class="o">(</span><span class="n">cond</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">whenContext</span>   <span class="k">=</span> <span class="k">new</span> <span class="nc">WhenContext</span><span class="o">(</span><span class="n">whenStatement</span><span class="o">)</span>

  <span class="nv">cond</span><span class="o">.</span><span class="py">globalData</span><span class="o">.</span><span class="py">dslScope</span><span class="o">.</span><span class="py">head</span><span class="o">.</span><span class="py">append</span><span class="o">(</span><span class="n">whenStatement</span><span class="o">)</span>

  <span class="nv">whenStatement</span><span class="o">.</span><span class="py">whenTrue</span><span class="o">.</span><span class="py">push</span><span class="o">()</span>
  <span class="n">block</span>
  <span class="nv">whenStatement</span><span class="o">.</span><span class="py">whenTrue</span><span class="o">.</span><span class="py">pop</span><span class="o">()</span>

  <span class="n">whenContext</span>
<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <ul>
      <li>在scala中，有两个参数分别用括号括起来，表示curry化。</li>
      <li>如果只有一个参数的话，可以使用大括号来代替小括号，从而更接近于一个原生的控制结构，如
        <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">if</span><span class="o">(</span><span class="n">cond</span><span class="o">){</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>when最后返回的<code class="highlighter-rouge">whenContext</code>是一个<code class="highlighter-rouge">WhenContext</code>类型，这个类型中还有一个方法叫做<code class="highlighter-rouge">otherwise</code>，很巧妙地构成了整个控制结构。</li>
    </ul>
  </li>
</ul>

<h3 id="惰性赋值">惰性赋值</h3>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span> <span class="k">=</span> <span class="nc">UInt</span><span class="o">(</span><span class="mi">8</span> <span class="n">bits</span><span class="o">)</span> <span class="c1">// Define 3 combinatorial signals</span>
<span class="n">c</span> <span class="o">:=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>   <span class="c1">// c will be set to 7</span>
<span class="n">b</span> <span class="o">:=</span> <span class="mi">2</span>       <span class="c1">// b will be set to 2</span>
<span class="n">a</span> <span class="o">:=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">3</span>   <span class="c1">// a will be set to 5</span>
</code></pre></div></div>

<p>和</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span> <span class="k">=</span> <span class="nc">UInt</span><span class="o">(</span><span class="mi">8</span> <span class="n">bits</span><span class="o">)</span> <span class="c1">// Define 3 combinatorial signals</span>
<span class="n">b</span> <span class="o">:=</span> <span class="mi">2</span>     <span class="c1">// b will be set to 2</span>
<span class="n">a</span> <span class="o">:=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">3</span> <span class="c1">// a will be set to 5</span>
<span class="n">c</span> <span class="o">:=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="c1">// c will be set to 7</span>
</code></pre></div></div>

<p>是等效的，因为比如<code class="highlighter-rouge">c := a+b</code> 并没有立刻计算出值，此时也算不出值，而只是将a+b这个函数赋值给c，等到之后再计算。</p>

  </div><!--
	<a href="https://github.com/Ncerzzk/Myblog/issues/118" class="css_btn_class">添加留言</a>
	-->
	
<div id="comment">
<li class="comment">
	
	<img class="comment_user_img"  height="40" width="40" src="https://avatars2.githubusercontent.com/u/9284611?v=4"></img>
	<div class="comment_box">
	<a class="comment_username" href="#">Username</a>
	<span class="comment_time">Comment at 2019.5.13</span>
	<div class="comment_content">Here is the Content</div>
	</div>
</li>
</div>
		
	
  <a class="u-url" href="/%E6%8A%80%E6%9C%AF/hdl/2020/06/13/SpinalHDL-xue-xi.html" hidden></a>
</article>

<script src="https://cdn.staticfile.org/jquery/2.0.0/jquery.min.js">
</script>

<script>

$(document).ready(function(){
  $("button").click(function(){
    $(this).hide();
  });
});
var h=$("#comment").html();
var user="Ncerzzk";
var repo="Myblog";
var issueid="118";
$("#comment").html("");
$.getJSON("https://api.github.com/repos/"+user+"/"+repo+"/issues/"+issueid+"/comments", function(json){
  for(i in json){
	  $("#comment").append(h);
	  $(".comment_username:last").text(json[i].user.login);
	  $(".comment_username:last").attr("href",json[i].user.html_url);
	  $(".comment_content:last").text(json[i].body);
	  $(".comment_time:last").text(json[i].created_at);
	  $(".comment_user_img:last").attr("src",json[i].user.avatar_url);
  }
});
</script>


      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Huangzzk&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Huangzzk&#39;s Blog</li><li><a class="u-email" href="mailto:e.255mail#gmail.com">e.255mail#gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Ncerzzk"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Ncerzzk</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Hello,world!</p>
      </div>
    </div>
	<div>
		<a href="http://beian.miit.gov.cn/">闽ICP备20002143号</a>
	</div>
  </div>

</footer>
</body>
<script>
  window.onload=function (){
    var content = document.getElementsByTagName("html")[0].innerHTML;
    content = content.replace(/博客|Blog|blog/g,"");
    console.log(content);

    document.getElementsByTagName("html")[0].innerHTML = content; 
  }
</script>
</html>
