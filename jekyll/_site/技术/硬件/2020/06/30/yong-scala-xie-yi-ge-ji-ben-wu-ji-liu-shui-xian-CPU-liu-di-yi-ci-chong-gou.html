<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>用scala写一个基本五级流水线CPU(六)第一次重构 | Huangzzk’s Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="用scala写一个基本五级流水线CPU(六)第一次重构" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CPU写到这里，流水线已经基本可以跑起来了，但是目前在写的过程中也渐渐感觉到一些问题，具体是：" />
<meta property="og:description" content="CPU写到这里，流水线已经基本可以跑起来了，但是目前在写的过程中也渐渐感觉到一些问题，具体是：" />
<link rel="canonical" href="https://ncerzzk.github.io/%E6%8A%80%E6%9C%AF/%E7%A1%AC%E4%BB%B6/2020/06/30/yong-scala-xie-yi-ge-ji-ben-wu-ji-liu-shui-xian-CPU-liu-di-yi-ci-chong-gou.html" />
<meta property="og:url" content="https://ncerzzk.github.io/%E6%8A%80%E6%9C%AF/%E7%A1%AC%E4%BB%B6/2020/06/30/yong-scala-xie-yi-ge-ji-ben-wu-ji-liu-shui-xian-CPU-liu-di-yi-ci-chong-gou.html" />
<meta property="og:site_name" content="Huangzzk’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-30T18:18:49+08:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ncerzzk.github.io/%E6%8A%80%E6%9C%AF/%E7%A1%AC%E4%BB%B6/2020/06/30/yong-scala-xie-yi-ge-ji-ben-wu-ji-liu-shui-xian-CPU-liu-di-yi-ci-chong-gou.html"},"url":"https://ncerzzk.github.io/%E6%8A%80%E6%9C%AF/%E7%A1%AC%E4%BB%B6/2020/06/30/yong-scala-xie-yi-ge-ji-ben-wu-ji-liu-shui-xian-CPU-liu-di-yi-ci-chong-gou.html","headline":"用scala写一个基本五级流水线CPU(六)第一次重构","dateModified":"2020-06-30T18:18:49+08:00","datePublished":"2020-06-30T18:18:49+08:00","description":"CPU写到这里，流水线已经基本可以跑起来了，但是目前在写的过程中也渐渐感觉到一些问题，具体是：","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://ncerzzk.github.io/feed.xml" title="Huangzzk's Blog" /><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9a0d201458675d03a87e467407e4889b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Huangzzk&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/aboutme/">关于</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <style type="text/css">
.css_btn_class {
	font-size:16px;
	font-family:Arial;
	font-weight:normal;
	-moz-border-radius:8px;
	-webkit-border-radius:8px;
	border-radius:8px;
	border:1px solid #dcdcdc;
	padding:9px 18px;
	text-decoration:none;
	background:-webkit-gradient( linear, left top, left bottom, color-stop(5%, #ffffff), color-stop(100%, #f6f6f6) );
	background:-moz-linear-gradient( center top, #ffffff 5%, #f6f6f6 100% );
	background:-ms-linear-gradient( top, #ffffff 5%, #f6f6f6 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#f6f6f6');
	background-color:#ffffff;
	color:#666666;
	display:inline-block;
	text-shadow:1px 1px 0px #ffffff;
 	-webkit-box-shadow:inset 1px 1px 0px 0px #ffffff;
 	-moz-box-shadow:inset 1px 1px 0px 0px #ffffff;
 	box-shadow:inset 1px 1px 0px 0px #ffffff;
}.css_btn_class:hover {
	background:-webkit-gradient( linear, left top, left bottom, color-stop(5%, #f6f6f6), color-stop(100%, #ffffff) );
	background:-moz-linear-gradient( center top, #f6f6f6 5%, #ffffff 100% );
	background:-ms-linear-gradient( top, #f6f6f6 5%, #ffffff 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#f6f6f6', endColorstr='#ffffff');
	background-color:#f6f6f6;
}.css_btn_class:active {
	position:relative;
	top:1px;
}

.comment_username{
font-size:14px;
margin-left:5px;
}
.comment_time{
font-size:14px;	
	float:right;
	margin-right:5px;
}
.comment{
	list-style:none;
}
.comment_username{
	color: #24292e;
	text-decoration: none;
	}
	.comment_user_img{
	float:left;
}
.comment_box{
	margin-left:40px;
    color: #24292e;
    background-color: #fff;
    border: 1px solid #d1d5da;
    border-radius: 3px;
}
.comment_content{
margin:10px 10px 10px 10px;
}

#comment{
	margin-top:30px;
}

.comment{
	margin-top:30px;
}

/* CSS按钮生成器 */
</style>

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">用scala写一个基本五级流水线CPU(六)第一次重构</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-06-30T18:18:49+08:00" itemprop="datePublished">Jun 30, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>CPU写到这里，流水线已经基本可以跑起来了，但是目前在写的过程中也渐渐感觉到一些问题，具体是：</p>

<ul>
  <li>流水线缓冲级的写法过于繁琐，虽然之前稍微了修改了一下，使显式连接没那么多，但问题还在</li>
  <li>增加指令较为麻烦，如果说是增加普通的I、R型指令，因此之前已经写好模式，直接增加即可。但在增加一些指令，比如MULT,MULTU,就发现了问题。因为这两个指令并不是向寄存器组的寄存器中写入，而是向寄存器HI,LO写入。那怎么办呢，修改前面的范式，让他除了能像寄存器组的寄存器写入，还能写入HI,LO吗？可想而知，最后那个范式会越来越复杂。</li>
</ul>

<p>重构计划：</p>

<ul>
  <li>目前流水线是由Component的形式组装起来的，但实际上，在spinalHDL，它建议不必要的时候，采用Area而不是另外建立Component，因为建立Component就意味着要重复定义输入输出端口。之前我虽然采用将端口抽象成类的方式，但仍有些累赘。
    <ul>
      <li>为什么一开始要采用Component呢，因为这是用Verilog写CPU的正常方法。以Verilog的表现力，如果将所有的东西挤在一个Module中，可想而知最后只能变成一坨屎山。但是</li>
      <li>因此，现在考虑使用Area来重构流水线</li>
    </ul>
  </li>
  <li>指令系统参考了VexRiscv的方法，打算用另外一个思路来写。
    <ul>
      <li>以前的思路是按照流水线为主的思路，在流水线的每一级，针对不同的指令做不同的操作。</li>
      <li>VexRiscv的思路是以指令为主，每个指令在每个阶段做什么事，直接Plug到该阶段。当然了，VexRiscv的实现比较复杂，我的scala功底还不够能完全理解他的实现方式，只能说先借鉴一下思想。</li>
    </ul>
  </li>
</ul>

<p>2020年7月5日 update:</p>

<h2 id="重构计划1使用area来重构流水线-----失败">重构计划1：使用Area来重构流水线     失败</h2>

<ul>
  <li>丢弃的分支在此：https://github.com/Ncerzzk/SimpleCPU/tree/AreaInsteadOfModule</li>
  <li>具体原因挺多的
    <ul>
      <li>使用Area来写整个流水线的话，生成的Verilog非常难以阅读。如果是用Component 来写的话，至少各个模块还能分开，但如果是用Area来写的话，整个CPU所有的东西都挤在一起，如果想通过verilog来看某些语句的效果的话，简直是噩梦。</li>
      <li>流水线之间只能通过一些中间信号的来连接，VexRiscv中使用了一些自建的数据结构来维护，如input(signal) output(signal) insert(signal)，等等。我也照猫画虎自己实现了一套，但是由于scala水平不够，写得略显臃肿，完全没有VexRiscv中那种轻便的感觉。越写越恶心</li>
      <li>为了更高程度的抽象，经常迷失在scala的语法中。虽然随着重构指令系统中，scala的水平又长进了一些，但即使这样，还是不太能驾驭高程度的抽象写法。</li>
    </ul>
  </li>
</ul>

<h2 id="重构计划2重构指令系统">重构计划2：重构指令系统</h2>

<p>本来想按照VexRiscv，直接将指令的行为plug到流水线中。但由于Area的重构搁浅，因此这方面没有实现。</p>

<p>目前的重构完的指令系统，使用SpinalHDL内置的MaskedLiteral来进行指令的匹配。</p>

<h3 id="指令定义">指令定义</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">ADD</span>     <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--100000"</span>
  <span class="k">def</span> <span class="nf">ADDU</span>    <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--100001"</span>
  <span class="k">def</span> <span class="nf">ADDI</span>    <span class="k">=</span> <span class="n">M</span><span class="s">"001000--_--------_--------_--------"</span>
  <span class="k">def</span> <span class="nf">ADDIU</span>   <span class="k">=</span> <span class="n">M</span><span class="s">"001001--_--------_--------_--------"</span>

  <span class="k">def</span> <span class="nf">AND</span>     <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--100100"</span>
  <span class="k">def</span> <span class="nf">ANDI</span>    <span class="k">=</span> <span class="n">M</span><span class="s">"001000--_--------_--------_--------"</span>

  <span class="k">def</span> <span class="nf">DIV</span>     <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--011010"</span>
  <span class="k">def</span> <span class="nf">DIVU</span>    <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--011011"</span>
  <span class="k">def</span> <span class="nf">MULT</span>    <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--011000"</span>
  <span class="k">def</span> <span class="nf">MULTU</span>   <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--011001"</span>

  <span class="k">def</span> <span class="nf">NOR</span>     <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--100111"</span>
  <span class="k">def</span> <span class="nf">OR</span>      <span class="k">=</span> <span class="n">M</span><span class="s">"000000--_--------_--------_--100101"</span>
  <span class="k">def</span> <span class="nf">ORI</span>     <span class="k">=</span> <span class="n">M</span><span class="s">"001101--_--------_--------_--------"</span>
  <span class="o">...</span>
</code></pre></div></div>

<p>MaskedLiteral可直接调用===与Bits类型进行匹配。</p>

<h3 id="指令译码行为的抽象">指令译码行为的抽象</h3>

<p>将指令译码的行为抽象出来，译码阶段的行为其实不多，抽象完变成这些：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">READ_REG0</span> <span class="k">extends</span> <span class="nc">Actions</span> <span class="c1">//  注意，如果READ_REGX为FALSE,则会默认使用Imm来替代(代码在ID的最后一部分）</span>
<span class="k">object</span> <span class="nc">READ_REG1</span> <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">WRITE_REG</span> <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">WRITE_REG_ADDR</span> <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">READ_REG0_ADDR</span> <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">READ_REG1_ADDR</span> <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">INST_OP</span>  <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">INST_OPSEL</span> <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">BRANCH_CONDITION</span> <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">BRANCH_OPRND2</span> <span class="k">extends</span> <span class="nc">Actions</span> <span class="c1">// 只需要设置2，因为OPRN1默认都是寄存器的值</span>
<span class="k">object</span> <span class="nc">WRITE_PC</span> <span class="k">extends</span> <span class="nc">Actions</span>
<span class="k">object</span> <span class="nc">BRANCH_TARGET</span> <span class="k">extends</span> <span class="nc">Actions</span>
</code></pre></div></div>

<p>有些行为的参数直接使用Bool类型的True或者False，有些行为的参数是特定的：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">RS</span> <span class="k">extends</span> <span class="nc">Arguments</span>
<span class="k">object</span> <span class="nc">RT</span> <span class="k">extends</span> <span class="nc">Arguments</span>
<span class="k">object</span> <span class="nc">RD</span> <span class="k">extends</span> <span class="nc">Arguments</span>

<span class="k">object</span> <span class="nc">IMMJ_ABSOLUTE</span> <span class="k">extends</span> <span class="nc">Arguments</span>
<span class="k">object</span> <span class="nc">IMMI_RELATIVE</span> <span class="k">extends</span> <span class="nc">Arguments</span>
<span class="k">object</span> <span class="nc">REG</span>  <span class="k">extends</span> <span class="nc">Arguments</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">RAW_BITS</span><span class="o">(</span><span class="n">b</span><span class="k">:</span><span class="kt">Bits</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Arguments</span>
</code></pre></div></div>

<p>然后将某一类的指令的共有行为抽出来，作为一个普通的Actions列表，如I型指令的共有行为：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">IActions</span><span class="k">=</span><span class="nc">HashMap</span><span class="o">(</span>
    <span class="nc">WRITE_REG</span>       <span class="o">-&gt;</span>  <span class="nc">True</span><span class="o">,</span>
    <span class="nc">WRITE_REG_ADDR</span>  <span class="o">-&gt;</span>  <span class="nc">RT</span><span class="o">,</span>
    <span class="nc">READ_REG0</span>       <span class="o">-&gt;</span>  <span class="nc">True</span><span class="o">,</span>
    <span class="nc">READ_REG0_ADDR</span>  <span class="o">-&gt;</span>  <span class="nc">RS</span><span class="o">,</span>
    <span class="nc">READ_REG1</span>       <span class="o">-&gt;</span>  <span class="nc">False</span>
  <span class="o">)</span>
</code></pre></div></div>

<p>当然了，每个指令还有一些独特的东西，比如OP码，和OPsel码，这些每个指令再单独添加：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">IInsts</span><span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
    <span class="nc">ORI</span> <span class="o">-&gt;(</span><span class="nc">IActions</span><span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span><span class="nc">INST_OP</span><span class="o">-&gt;</span> <span class="nv">OpEnum</span><span class="o">.</span><span class="py">LOGIC</span><span class="o">,</span><span class="nc">INST_OPSEL</span><span class="o">-&gt;</span><span class="nv">OPLogic</span><span class="o">.</span><span class="py">OR</span><span class="o">)),</span>
    <span class="nc">ANDI</span> <span class="o">-&gt;(</span><span class="nc">IActions</span><span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span><span class="nc">INST_OP</span><span class="o">-&gt;</span> <span class="nv">OpEnum</span><span class="o">.</span><span class="py">LOGIC</span><span class="o">,</span><span class="nc">INST_OPSEL</span><span class="o">-&gt;</span><span class="nv">OPLogic</span><span class="o">.</span><span class="py">AND</span><span class="o">)),</span>
    <span class="nc">XORI</span> <span class="o">-&gt;(</span><span class="nc">IActions</span><span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span><span class="nc">INST_OP</span><span class="o">-&gt;</span> <span class="nv">OpEnum</span><span class="o">.</span><span class="py">LOGIC</span><span class="o">,</span><span class="nc">INST_OPSEL</span><span class="o">-&gt;</span><span class="nv">OPLogic</span><span class="o">.</span><span class="py">XOR</span><span class="o">)),</span>
    <span class="nc">ADDIU</span> <span class="o">-&gt;(</span><span class="nc">IActions</span><span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span><span class="nc">INST_OP</span><span class="o">-&gt;</span> <span class="nv">OpEnum</span><span class="o">.</span><span class="py">ALU</span><span class="o">,</span><span class="nc">INST_OPSEL</span><span class="o">-&gt;</span><span class="nv">OPArith</span><span class="o">.</span><span class="py">ADDU</span><span class="o">)),</span>
    <span class="nc">ADDI</span> <span class="o">-&gt;(</span><span class="nc">IActions</span><span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span><span class="nc">INST_OP</span><span class="o">-&gt;</span> <span class="nv">OpEnum</span><span class="o">.</span><span class="py">ALU</span><span class="o">,</span><span class="nc">INST_OPSEL</span><span class="o">-&gt;</span><span class="nv">OPArith</span><span class="o">.</span><span class="py">ADD</span><span class="o">)),</span>
    <span class="nc">SLTI</span> <span class="o">-&gt;(</span><span class="nc">IActions</span><span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span><span class="nc">INST_OP</span><span class="o">-&gt;</span> <span class="nv">OpEnum</span><span class="o">.</span><span class="py">ALU</span><span class="o">,</span><span class="nc">INST_OPSEL</span><span class="o">-&gt;</span><span class="nv">OPArith</span><span class="o">.</span><span class="py">SLT</span><span class="o">)),</span>
    <span class="nc">SLTIU</span> <span class="o">-&gt;(</span><span class="nc">IActions</span><span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span><span class="nc">INST_OP</span><span class="o">-&gt;</span> <span class="nv">OpEnum</span><span class="o">.</span><span class="py">ALU</span><span class="o">,</span><span class="nc">INST_OPSEL</span><span class="o">-&gt;</span><span class="nv">OPArith</span><span class="o">.</span><span class="py">SLTU</span><span class="o">))</span>
  <span class="o">)</span>
</code></pre></div></div>

<p>J型指令由于行为差别都比较大，对每个指令添加的东西比较多：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">JInsts</span><span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
      <span class="n">J</span><span class="o">-&gt;</span><span class="nc">JActions</span><span class="o">,</span>
      <span class="nc">JAL</span><span class="o">-&gt;(</span><span class="nc">JActions</span> <span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span>
        <span class="nc">WRITE_REG</span><span class="o">-&gt;</span><span class="nc">True</span><span class="o">,</span>
        <span class="nc">WRITE_REG_ADDR</span><span class="o">-&gt;</span><span class="nc">RAW_BITS</span><span class="o">(</span><span class="nf">B</span><span class="o">(</span><span class="s">"32'd31"</span><span class="o">))</span>
      <span class="o">)),</span>
      <span class="nc">JR</span><span class="o">-&gt;(</span><span class="nc">JActions</span> <span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span>
        <span class="nc">BRANCH_TARGET</span><span class="o">-&gt;</span><span class="nc">REG</span><span class="o">,</span>
        <span class="nc">READ_REG0</span> <span class="o">-&gt;</span> <span class="nc">True</span><span class="o">,</span>
        <span class="nc">READ_REG0_ADDR</span> <span class="o">-&gt;</span> <span class="nc">RS</span>
      <span class="o">)),</span>
      <span class="nc">JALR</span><span class="o">-&gt;(</span><span class="nc">JActions</span> <span class="o">++</span> <span class="nc">HashMap</span><span class="o">(</span>
        <span class="nc">BRANCH_TARGET</span><span class="o">-&gt;</span><span class="nc">REG</span><span class="o">,</span>
        <span class="nc">READ_REG0</span> <span class="o">-&gt;</span> <span class="nc">True</span><span class="o">,</span>
        <span class="nc">READ_REG0_ADDR</span> <span class="o">-&gt;</span> <span class="nc">RS</span><span class="o">,</span>
        <span class="nc">WRITE_REG</span><span class="o">-&gt;</span><span class="nc">True</span><span class="o">,</span>
        <span class="nc">WRITE_REG_ADDR</span><span class="o">-&gt;</span><span class="nc">RAW_BITS</span><span class="o">(</span><span class="nf">B</span><span class="o">(</span><span class="s">"32'd31"</span><span class="o">))</span>
      <span class="o">))</span>
  <span class="o">)</span>
</code></pre></div></div>

<p>然后在ID模块中，遍历匹配指令，匹配到之后，根据指令的行为列表，操作具体端口:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">doDecode</span><span class="o">(</span><span class="n">instsList</span><span class="k">:</span><span class="kt">immutable.Seq</span><span class="o">[(</span><span class="kt">MaskedLiteral</span>, <span class="kt">Map</span><span class="o">[</span><span class="kt">Actions</span>, <span class="k">_</span><span class="o">])])</span> <span class="o">={</span>
    <span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="n">instsList</span><span class="o">){</span>
      <span class="nf">when</span><span class="o">(</span><span class="nv">inst</span><span class="o">.</span><span class="py">raw</span> <span class="o">===</span> <span class="nv">i</span><span class="o">.</span><span class="py">_1</span><span class="o">){</span>
        <span class="nf">for</span><span class="o">((</span><span class="n">action</span><span class="o">,</span><span class="n">argument</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="nv">i</span><span class="o">.</span><span class="py">_2</span><span class="o">){</span>
          <span class="nf">if</span><span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="nc">READ_REG0</span><span class="o">){</span>
            <span class="nv">regHeap</span><span class="o">.</span><span class="py">readEns</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">:=</span> <span class="nv">argument</span><span class="o">.</span><span class="py">asInstanceOf</span><span class="o">[</span><span class="kt">Bool</span><span class="o">]</span>
          <span class="o">}</span><span class="k">else</span> <span class="nf">if</span><span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="nc">READ_REG1</span><span class="o">){</span>
            <span class="nv">regHeap</span><span class="o">.</span><span class="py">readEns</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="nv">argument</span><span class="o">.</span><span class="py">asInstanceOf</span><span class="o">[</span><span class="kt">Bool</span><span class="o">]</span>
          <span class="o">}</span><span class="k">else</span> <span class="nf">if</span><span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="nc">WRITE_REG</span><span class="o">){</span>
            <span class="nv">idOut</span><span class="o">.</span><span class="py">writeReg</span> <span class="o">:=</span> <span class="nv">argument</span><span class="o">.</span><span class="py">asInstanceOf</span><span class="o">[</span><span class="kt">Bool</span><span class="o">]</span>
          <span class="o">...</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>这样一来，译码模块就显得清爽很多了：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">val</span> <span class="nv">inst</span> <span class="k">=</span> <span class="nc">INST</span><span class="o">(</span><span class="nv">lastStage</span><span class="o">.</span><span class="py">inst</span><span class="o">)</span>
  <span class="c1">//决定立即数的符号位拓展</span>
  <span class="k">val</span> <span class="nv">imm</span><span class="k">:</span><span class="kt">Bits</span> <span class="o">=</span> <span class="o">(</span><span class="nv">idOut</span><span class="o">.</span><span class="py">op</span> <span class="o">===</span> <span class="nv">OpEnum</span><span class="o">.</span><span class="py">LOGIC</span><span class="o">.</span><span class="py">asBits</span><span class="o">.</span><span class="py">resize</span><span class="o">(</span><span class="nv">idOut</span><span class="o">.</span><span class="py">op</span><span class="o">.</span><span class="py">getWidth</span><span class="o">))?</span>
    <span class="nv">inst</span><span class="o">.</span><span class="py">immI</span><span class="o">.</span><span class="py">resize</span><span class="o">(</span><span class="nv">GlobalConfig</span><span class="o">.</span><span class="py">dataBitsWidth</span><span class="o">)|</span>
    <span class="nv">inst</span><span class="o">.</span><span class="py">immI</span><span class="o">.</span><span class="py">asSInt</span><span class="o">.</span><span class="py">resize</span><span class="o">(</span><span class="nv">GlobalConfig</span><span class="o">.</span><span class="py">dataBitsWidth</span><span class="o">).</span><span class="py">asBits</span>

  <span class="nf">doDecode</span><span class="o">(</span><span class="nv">Insts</span><span class="o">.</span><span class="py">AllInsts</span><span class="o">)</span>
  
  <span class="k">var</span> <span class="n">i</span> <span class="k">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="nf">for</span><span class="o">(</span> <span class="n">rnd</span> <span class="k">&lt;-</span> <span class="nc">List</span><span class="o">(</span><span class="nv">idOut</span><span class="o">.</span><span class="py">opRnd1</span><span class="o">,</span><span class="nv">idOut</span><span class="o">.</span><span class="py">opRnd2</span><span class="o">)){</span>
    <span class="nf">when</span><span class="o">(</span><span class="nv">regHeap</span><span class="o">.</span><span class="py">readEns</span><span class="o">(</span><span class="n">i</span><span class="o">)){</span>
      <span class="n">rnd</span> <span class="o">:=</span> <span class="nv">regHeap</span><span class="o">.</span><span class="py">readDatas</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
      <span class="nf">when</span><span class="o">(</span><span class="nv">exBack</span><span class="o">.</span><span class="py">writeReg</span> <span class="o">&amp;&amp;</span> <span class="nv">exBack</span><span class="o">.</span><span class="py">writeRegAddr</span><span class="o">===</span><span class="nv">regHeap</span><span class="o">.</span><span class="py">readAddrs</span><span class="o">(</span><span class="n">i</span><span class="o">)){</span>
        <span class="n">rnd</span> <span class="o">:=</span> <span class="nv">exBack</span><span class="o">.</span><span class="py">writeData</span>
      <span class="o">}</span><span class="nf">elsewhen</span><span class="o">(</span><span class="nv">memBack</span><span class="o">.</span><span class="py">writeReg</span> <span class="o">&amp;&amp;</span> <span class="nv">memBack</span><span class="o">.</span><span class="py">writeRegAddr</span><span class="o">===</span><span class="nv">regHeap</span><span class="o">.</span><span class="py">readAddrs</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">rnd</span> <span class="o">:=</span> <span class="nv">memBack</span><span class="o">.</span><span class="py">writeData</span>
      <span class="o">}</span><span class="nf">elsewhen</span><span class="o">(</span><span class="nv">wbBack</span><span class="o">.</span><span class="py">writeEn</span> <span class="o">&amp;&amp;</span> <span class="nv">wbBack</span><span class="o">.</span><span class="py">writeAddr</span><span class="o">===</span><span class="nv">regHeap</span><span class="o">.</span><span class="py">readAddrs</span><span class="o">(</span><span class="n">i</span><span class="o">)){</span>
        <span class="n">rnd</span> <span class="o">:=</span> <span class="nv">wbBack</span><span class="o">.</span><span class="py">writeData</span>
      <span class="o">}</span>
    <span class="o">}</span><span class="n">otherwise</span><span class="o">{</span>
      <span class="n">rnd</span> <span class="o">:=</span> <span class="n">imm</span>
    <span class="o">}</span>
    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
  <span class="o">}</span>
</code></pre></div></div>

  </div><!--
	<a href="https://github.com/Ncerzzk/Myblog/issues/126" class="css_btn_class">添加留言</a>
	-->
	
<div id="comment">
<li class="comment">
	
	<img class="comment_user_img"  height="40" width="40" src="https://avatars2.githubusercontent.com/u/9284611?v=4"></img>
	<div class="comment_box">
	<a class="comment_username" href="#">Username</a>
	<span class="comment_time">Comment at 2019.5.13</span>
	<div class="comment_content">Here is the Content</div>
	</div>
</li>
</div>
		
	
  <a class="u-url" href="/%E6%8A%80%E6%9C%AF/%E7%A1%AC%E4%BB%B6/2020/06/30/yong-scala-xie-yi-ge-ji-ben-wu-ji-liu-shui-xian-CPU-liu-di-yi-ci-chong-gou.html" hidden></a>
</article>

<script src="https://cdn.staticfile.org/jquery/2.0.0/jquery.min.js">
</script>

<script>

$(document).ready(function(){
  $("button").click(function(){
    $(this).hide();
  });
});
var h=$("#comment").html();
var user="Ncerzzk";
var repo="Myblog";
var issueid="126";
$("#comment").html("");
$.getJSON("https://api.github.com/repos/"+user+"/"+repo+"/issues/"+issueid+"/comments", function(json){
  for(i in json){
	  $("#comment").append(h);
	  $(".comment_username:last").text(json[i].user.login);
	  $(".comment_username:last").attr("href",json[i].user.html_url);
	  $(".comment_content:last").text(json[i].body);
	  $(".comment_time:last").text(json[i].created_at);
	  $(".comment_user_img:last").attr("src",json[i].user.avatar_url);
  }
});
</script>


      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Huangzzk&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Huangzzk&#39;s Blog</li><li><a class="u-email" href="mailto:e.255mail#gmail.com">e.255mail#gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Ncerzzk"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Ncerzzk</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Hello,world!</p>
      </div>
    </div>
	<div>
		<a href="http://beian.miit.gov.cn/">闽ICP备20002143号</a>
	</div>
  </div>

</footer>
</body>
<script>
  window.onload=function (){
    var content = document.getElementsByTagName("html")[0].innerHTML;
    content = content.replace(/博客|Blog|blog/g,"");
    console.log(content);

    document.getElementsByTagName("html")[0].innerHTML = content; 
  }
</script>
</html>
